{% extends "site_base.html" %}

{% load i18n %}
{% load ifsetting_tag %}

{% block head_title %}{% trans "Detail" %}{% endblock %}

{% comment %}
    remove the title bar
{% endcomment %}
{% block topbar_base %}{% endblock %}  

{% block extra_head %}
<link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}css/tag.css">
<link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}css/article.css">
<link rel="stylesheet" href="{{ STATIC_URL }}css/prettify.css">
<script src="{{ STATIC_URL }}js/prettify.js"></script>
<script type="text/javascript" charset="utf-8">
$(document).ready(function() { 
    prettyPrint();


    var remove_tag = function($item) {
        $item.detach();
        var name = $item.find('.name').text();
        var id = $('#article_id').text();
        $.post('/reader/article/untag/', {
                "tag_name": name,
                "article_id": id
            },
            function(data) {
                console.log('tag: ' + name + ' removed.');
            });
    };

    var add_tag = function(name) {
        var item = $('<div class="tag"> <div class="arrow"></div> <div class="co"> <span class="name">' + name + '</span> </div> </div>');
        $('.tag-list').append(item);
        item.click(function() {
            remove_tag(item);
        });


        var id = $('#article_id').text();
        $.post('/reader/article/tag/', {
                "tag_name": name,
                "article_id": id
            },
            function(data) {
                console.log('tag: ' + name + ' added.');
            });
    };

    $("#article-header .arrow").click(function() {
        var tag = $(this).parent();
        remove_tag(tag);
    });

    var tag_url = "/reader/tag/autocomplete" 
    $.get(tag_url, function(data) {
        var tags = JSON.parse(data)['tags'];
        $('#tag-input').typeahead({source: tags}).keyup(function(evt) {
            if (evt.keyCode == 13) {
                var tag = $(this).val();
                $('#tag-input').val("");
                if (!tag)
                    return ;
                add_tag(tag);
            }
        });
    });

});
</script>
{% endblock %}


{% block body %}
<div class="wrapper">
    <section id="content">
        <article>
            <header id="article-header"> 
               <div class="tag-list">
                <div id="tag-input-container">
                    <input type="text" id="tag-input" class="span2" name="tag-input" value="" placeholder="add tag">
                </div>
                {% for tag in article.tags.all %}
                    <div class="tag">
                        <div class="arrow"></div>
                        <div class="co">
                            <span class="name">{{tag.name}}</span>
                        </div>
                    </div>
                {% endfor %}
               </div>
               <div id="title-container">
                   <h1 id="article-title">
                       <a id="article-url" href="{{article.url}}" title="View original" 
                        style="background: transparent url('https://s2.googleusercontent.com/s2/favicons?domain={{article.site_url}}') 0 center no-repeat;"></a>
                       {{article.title}}</h1>
               </div>
            <div id="article-meta-container">
                <aside id="article-meta">
               {% if article.author or article.published %}
                    <span class="author">{{article.author}}</span>
                    <span> - </span>
                    <span class="published">{{article.published}}</span>
                {% endif %}
                </aside>
            </div>
            </header> 
            <section id="article-content">
                {{ article.content|safe }}
            </section>
        </article>
    </section>
    <div id="article_id" class="hidden">{{article.id}}</div>
</div>
{% endblock %}

